name: Build Android Java Library

on:
  push:
    paths:
      - "Ar/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---- Install Java 17 ONLY for Android SDK ----
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ---- Install Android SDK properly ----
      - name: Install Android SDK 28
        run: |
          mkdir -p $HOME/android-sdk
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
          unzip -q sdk.zip -d $HOME/android-sdk
          yes | $HOME/android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$HOME/android-sdk "platforms;android-28"

      # ---- Switch JVM to Java 8 for Sketchware-safe bytecode ----
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      # ---- Compile Java 8 bytecode ----
      - name: Compile library
        run: |
          rm -rf out
          mkdir out
          javac -g:none -nowarn -encoding UTF-8 \
            -source 1.8 -target 1.8 \
            -cp $HOME/android-sdk/platforms/android-28/android.jar \
            -d out $(find Ar -name "*.java")

      # ---- Package clean jar ----
      - name: Build jar
        run: |
          cd out
          jar cf ../classes.jar .

      # ---- Store into repo ----
      - name: Save jar
        run: |
          mkdir -p library
          mv classes.jar library/classes.jar

      - name: Commit jar
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add library/classes.jar
          git commit -m "Auto build library jar" || echo "No changes"
          git push